<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>College Lab Kiosk - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        body {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        .card-header {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border-radius: 20px 20px 0 0;
            color: white;
            padding: 30px;
            text-align: center;
        }
        .card-header h2 { margin: 0; font-size: 2rem; }
        .system-info {
            background: rgba(220, 53, 69, 0.1);
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-section { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-control {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
        }
        .btn-login {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        .btn-secondary {
            background: #ffc107;
            border: none;
            color: #000;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background: #ffb300;
            transform: translateY(-2px);
        }
        .session-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .session-modal.active {
            display: flex;
        }
        .session-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .session-card h1 {
            color: #28a745;
            margin-bottom: 20px;
        }
        .alert {
            display: none;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 16px;
            font-weight: 500;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- ERROR ALERT - Always visible at top -->
    <div id="errorAlert" class="alert">
        <strong>Error:</strong> <span id="errorMessage"></span>
    </div>

    <!-- LOGIN PAGE -->
    <div class="login-container">
        <div class="login-card">
            <div class="card-header">
                <h2><i class="fas fa-lock"></i> College Lab Kiosk</h2>
                <p class="mb-0">Secure Student Login</p>
            </div>

            <div class="system-info">
                <strong><i class="fas fa-info-circle"></i> System Information</strong>
                <div style="margin-top: 10px;">
                    <div>Computer: <strong id="computerName">Loading...</strong></div>
                    <div>Lab: <strong>CC1</strong></div>
                    <div>System Number: <strong id="systemNumber">CC1-01</strong></div>
                    <div>Current Time: <strong id="currentTime">--:--:--</strong></div>
                </div>
            </div>

            <div class="form-section">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user"></i> <strong>Student ID</strong></label>
                        <input type="text" class="form-control" id="studentId" placeholder="Enter your Student ID" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-key"></i> <strong>Password</strong></label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                    </div>

                    <button type="submit" class="btn-login">
                        <i class="fas fa-unlock"></i> Login
                    </button>
                </form>

                <button type="button" class="btn-secondary" onclick="showForgotPassword()">
                    <i class="fas fa-key"></i> Forgot Password?
                </button>

                <button type="button" class="btn-secondary" onclick="showFirstTimeSignin()">
                    <i class="fas fa-user-plus"></i> First-time Sign-in
                </button>

                <button type="button" class="btn-secondary" onclick="showGuestLogin()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="fas fa-user-shield"></i> Guest Mode
                </button>
            </div>
        </div>
    </div>

    <!-- Guest Login Modal -->
    <div class="session-modal" id="guestLoginModal">
        <div class="session-card">
            <h1><i class="fas fa-user-shield"></i> Guest Mode Login</h1>
            <p style="color: #6c757d; margin-bottom: 20px;">Enter the 4-digit guest password provided by your administrator</p>
            <form id="guestLoginForm">
                <div class="form-group">
                    <label class="form-label"><strong>Guest Password (4 digits)</strong></label>
                    <input type="password" class="form-control" id="guestPassword" placeholder="Enter 4-digit password" maxlength="4" pattern="[0-9]{4}" required style="text-align: center; font-size: 24px; letter-spacing: 8px;">
                </div>
                <button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    <i class="fas fa-sign-in-alt"></i> Login as Guest
                </button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Session Active & Screen Mirroring -->
    <div class="session-modal" id="sessionModal">
        <div class="session-card">
            <h1><i class="fas fa-check-circle"></i> Session Active!</h1>
            <p><strong>Welcome,</strong> <span id="sessionStudentName">Student</span></p>
            <p><strong>Student ID:</strong> <span id="sessionStudentId">---</span></p>
            <p><strong>System:</strong> <span id="sessionSystem">---</span></p>
            <p><strong>Login Time:</strong> <span id="sessionLoginTime">---</span></p>
            <button type="button" class="btn btn-danger btn-lg" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="session-modal" id="forgotPasswordModal">
        <div class="session-card">
            <h1><i class="fas fa-key"></i> Forgot Password</h1>
            <div id="forgotStep1">
                <p>Enter your Student ID:</p>
                <input type="text" class="form-control mb-3" id="forgotStudentId" placeholder="Student ID">
                <button type="button" class="btn btn-primary w-100" onclick="forgotPasswordStep2()">Next</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </div>
            <div id="forgotStep2" style="display:none;">
                <p>Enter your college email address:</p>
                <input type="email" class="form-control mb-2" id="forgotEmail" placeholder="yourname@psgitech.ac.in">
                <small class="text-muted" style="display: block; margin-bottom: 12px;">
                    <i class="fas fa-info-circle"></i> Only @psgitech.ac.in emails are accepted
                </small>
                <button type="button" class="btn btn-primary w-100" onclick="sendOTP()">Send OTP</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </div>
            <div id="forgotStep3" style="display:none;">
                <p>Enter OTP and new password:</p>
                <input type="text" class="form-control mb-2" id="otpCode" placeholder="OTP Code" maxlength="6">
                <input type="password" class="form-control mb-2" id="newPassword" placeholder="New Password">
                <input type="password" class="form-control mb-3" id="confirmPassword" placeholder="Confirm Password">
                <button type="button" class="btn btn-primary w-100" onclick="verifyOTP()">Reset Password</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- First-time Sign-in Modal -->
    <div class="session-modal" id="firstTimeModal">
        <div class="session-card">
            <h1><i class="fas fa-user-plus"></i> First-time Sign-in</h1>
            <form id="firstTimeForm">
                <div class="form-group">
                    <label class="form-label">Student ID:</label>
                    <input type="text" class="form-control" id="ftStudentId" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email:</label>
                    <input type="email" class="form-control" id="ftEmail" placeholder="yourname@psgitech.ac.in" required>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Only @psgitech.ac.in emails are accepted
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">Date of Birth:</label>
                    <input type="date" class="form-control" id="ftDOB" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password:</label>
                    <input type="password" class="form-control" id="ftPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password:</label>
                    <input type="password" class="form-control" id="ftConfirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Create Account</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        console.log('âœ… Student interface loaded');

        let socket = null;
        let pc = null;
        let remoteVideo = null;
        
        // Offer queue system to prevent overwhelming kiosk with rapid restarts
        let isProcessingOffer = false;
        let offerQueue = [];
        let currentDisplayStream = null;
        
        // Pre-warmed screen stream for instant mirroring
        let preWarmedStream = null;
        let isScreenReady = false;

        // Initialize Socket.io for guest mode and screen mirroring
        function initializeSocket() {
            try {
                if (!window.electronAPI || !window.electronAPI.getServerUrl) {
                    console.log('âš ï¸ window.electronAPI not available');
                    return;
                }
                
                window.electronAPI.getServerUrl().then(serverUrl => {
                    console.log(`ðŸ“¡ ========================================`);
                    console.log(`ðŸ“¡ CONNECTING TO SERVER: ${serverUrl}`);
                    console.log(`ðŸ“¡ ========================================`);
                    socket = io(serverUrl, {
                        reconnection: true,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000,
                        reconnectionAttempts: Infinity,
                        transports: ['websocket', 'polling'],
                        // ðŸš€ OPTIMIZATION: Keep connection alive
                        pingTimeout: 60000,
                        pingInterval: 25000,
                        // Upgrade to WebSocket ASAP for lower latency
                        upgrade: true,
                        rememberUpgrade: true
                    });

                    // ðŸŽ« SOCKET CONNECTION EVENTS
                    socket.on('connect', () => {
                        const systemNumber = document.getElementById('systemNumber')?.textContent || 'CC1-01';
                        console.log(`âœ…âœ…âœ… SOCKET CONNECTED SUCCESSFULLY!`);
                        console.log(`ðŸŽ« Socket ID: ${socket.id}`);
                        console.log(`ðŸŽ« System Number: ${systemNumber}`);
                        console.log(`ðŸŽ« KIOSK: Registering with server (pre-login) - System: ${systemNumber}`);
                        socket.emit('register-kiosk', {
                            sessionId: null,  // Will be updated after login
                            systemNumber: systemNumber,
                            labId: 'CC1'  // Default lab
                        });
                        console.log('âœ… Register-kiosk event emitted');
                    });
                    
                    socket.on('connect_error', (error) => {
                        console.error('âŒ SOCKET CONNECTION ERROR:', error);
                    });
                    
                    socket.on('disconnect', (reason) => {
                        console.warn('âš ï¸ SOCKET DISCONNECTED:', reason);
                    });
                    
                    socket.on('reconnect', (attemptNumber) => {
                        console.log(`âœ… SOCKET RECONNECTED after ${attemptNumber} attempts`);
                    });

                    // ðŸŽ« LISTEN FOR SESSION LOGIN SUCCESS - Critical for screen mirroring
                    socket.on('session-login-success', (data) => {
                        console.log('âœ… Session login success received:', data);
                        const currentSystem = document.getElementById('systemNumber')?.textContent || 'CC1-01';
                        
                        // Only re-register if this is for our system
                        if (data.systemNumber === currentSystem) {
                            console.log('ðŸŽ« KIOSK: RE-REGISTERING with sessionId:', data.sessionId);
                            socket.emit('register-kiosk', {
                                sessionId: data.sessionId,
                                systemNumber: data.systemNumber,
                                labId: data.labId || 'CC1'
                            });
                            
                            // ðŸš€ PRE-WARM: Capture screen immediately
                            preWarmScreenCapture().then(() => {
                                // Notify that screen is ready
                                socket.emit('kiosk-screen-ready', {
                                    sessionId: data.sessionId,
                                    hasVideo: true,
                                    timestamp: new Date().toISOString()
                                });
                                console.log('ðŸ“º KIOSK: Screen pre-warmed and ready');
                            }).catch(err => {
                                console.error('âŒ Pre-warm failed:', err.message);
                                // Still notify, will capture on-demand
                                socket.emit('kiosk-screen-ready', {
                                    sessionId: data.sessionId,
                                    hasVideo: false,
                                    timestamp: new Date().toISOString()
                                });
                            });
                        }
                    });

                    // ðŸ”“ GUEST ACCESS / BYPASS LOGIN
                    socket.on('enable-guest-access', async (data) => {
                        const currentSystem = document.getElementById('systemNumber')?.textContent || 'CC1-01';
                        console.log('ðŸ”“ Guest access command received for:', data.systemNumber, '| Current system:', currentSystem);
                        
                        // Check if this command is for this system
                        if (data.systemNumber === currentSystem) {
                            console.log('âœ… System match! Enabling guest access...');
                            await handleGuestAccess(data);
                        } else {
                            console.log('â­ï¸ Command not for this system, ignoring');
                        }
                    });

                    socket.on('guest-access-granted', (data) => {
                        console.log('ðŸ”“ Guest access event received');
                        handleGuestMode(data);
                    });

                    // Screen mirroring: admin offer for WebRTC
                    socket.on('admin-offer', async (data) => {
                        console.log('ðŸ“¹ ========================================');
                        console.log('ðŸ“¹ ADMIN OFFER RECEIVED');
                        console.log('ðŸ“¹ Session ID:', data.sessionId);
                        console.log('ðŸ“¹ Admin Socket ID:', data.adminSocketId);
                        console.log('ðŸ“¹ ========================================');
                        
                        // ðŸš€ OPTIMIZATION: Process immediately if not busy, otherwise queue
                        if (isProcessingOffer) {
                            console.log('â³ KIOSK: Busy, queueing offer...');
                            offerQueue.push(data);
                            console.log(`ðŸ“‹ Queue size: ${offerQueue.length}`);
                            return;
                        }
                        
                        try {
                            await handleAdminOffer(data);
                        } catch (error) {
                            console.error('âŒ Error handling offer:', error);
                        } finally {
                            // ðŸš€ Process next queued offer immediately
                            if (offerQueue.length > 0) {
                                const nextOffer = offerQueue.shift();
                                console.log(`ðŸ”„ Processing queued offer (${offerQueue.length} remaining)`);
                                // Process immediately without delay for faster multi-system handling
                                setTimeout(() => handleAdminOffer(nextOffer), 100);
                            }
                        }
                    });

                    // ICE candidates for WebRTC
                    socket.on('webrtc-ice-candidate', (data) => {
                        if (pc && data.candidate) {
                            pc.addIceCandidate(new RTCIceCandidate(data.candidate))
                                .catch(e => console.error('âŒ Error adding ICE candidate:', e));
                        }
                    });

                    // Session ended by admin or automatic timetable
                    socket.on('session-ended', (data) => {
                        console.log('â³ Session ended notification received:', data);
                        handleSessionEnded(data);
                    });

                    // Lab session ended (automatic timetable end)
                    socket.on('lab-session-ended', (data) => {
                        console.log('â³ Lab session ended:', data);
                        handleSessionEnded(data);
                    });

                    // ADMIN REMOTE SHUTDOWN - Execute immediate shutdown
                    socket.on('execute-shutdown', async () => {
                        console.log('ðŸ”Œ ADMIN SHUTDOWN COMMAND RECEIVED');
                        console.log('âš ï¸ System will shut down in 10 seconds...');
                        
                        // Show immediate warning to student
                        showError('âš ï¸ ADMIN SHUTDOWN: This system will shut down in 10 seconds. Please save your work!', 'error');
                        
                        // If electronAPI has shutdown method, use it
                        if (window.electronAPI && window.electronAPI.adminShutdown) {
                            try {
                                // 10 second delay to allow student to see warning
                                await new Promise(resolve => setTimeout(resolve, 10000));
                                
                                console.log('ðŸ”Œ Executing admin-initiated shutdown...');
                                await window.electronAPI.adminShutdown();
                            } catch (error) {
                                console.error('âŒ Admin shutdown error:', error);
                            }
                        } else {
                            console.error('âŒ Admin shutdown API not available');
                            // Fallback: just logout and return to kiosk screen
                            setTimeout(() => {
                                logout();
                            }, 10000);
                        }
                    });

                }).catch(err => console.error('âŒ Error getting server URL:', err));
            } catch (error) {
                console.error('âŒ Socket error:', error);
            }
        }
        
        // ðŸš€ PRE-WARM: Capture screen stream in advance for instant mirroring
        async function preWarmScreenCapture() {
            if (preWarmedStream) {
                console.log('âœ… Screen already pre-warmed');
                return preWarmedStream;
            }
            
            console.log('ðŸš€ ========================================');
            console.log('ðŸš€ PRE-WARMING SCREEN CAPTURE');
            console.log('ðŸš€ ========================================');
            
            try {
                // Try getDisplayMedia first
                try {
                    preWarmedStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: 'always',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30 }
                        },
                        audio: false
                    });
                    console.log('âœ… Pre-warm: getDisplayMedia() succeeded');
                } catch (error1) {
                    console.log('âš ï¸ Pre-warm: getDisplayMedia failed, trying getUserMedia...');
                    
                    // Fallback to getUserMedia with chromeMediaSource
                    const sources = await window.electronAPI.getScreenSources();
                    if (sources.length === 0) {
                        throw new Error('No screen sources available');
                    }
                    
                    const screenSource = sources[0];
                    preWarmedStream = await navigator.mediaDevices.getUserMedia({
                        audio: false,
                        video: {
                            mandatory: {
                                chromeMediaSource: 'desktop',
                                chromeMediaSourceId: screenSource.id,
                                minWidth: 1280,
                                maxWidth: 1920,
                                minHeight: 720,
                                maxHeight: 1080,
                                maxFrameRate: 30
                            }
                        }
                    });
                    console.log('âœ… Pre-warm: getUserMedia succeeded');
                }
                
                console.log('âœ…âœ…âœ… Screen pre-warmed successfully!');
                console.log('âœ… Tracks:', preWarmedStream.getTracks().length);
                preWarmedStream.getTracks().forEach(track => {
                    console.log(`  - ${track.kind}: ${track.label} (${track.readyState})`);
                });
                
                isScreenReady = true;
                return preWarmedStream;
            } catch (error) {
                console.error('âŒ Pre-warm failed:', error.message);
                isScreenReady = false;
                throw error;
            }
        }

        async function handleAdminOffer(data) {
            console.log('ðŸ“¹ ========================================');
            console.log('ðŸ“¹ KIOSK: Handling admin offer for screen mirroring');
            const { offer, sessionId, adminSocketId } = data;
            console.log('ðŸ“¹ KIOSK: Offer params:', { hasOffer: !!offer, sessionId, adminSocketId });
            
            // Set processing flag
            isProcessingOffer = true;
            
            // Add timestamp to track how long this takes
            const startTime = Date.now();
            
            try {
                // Cleanup existing display stream if any
                if (currentDisplayStream) {
                    console.log('ðŸ§½ KIOSK: Stopping existing display stream before creating new one');
                    currentDisplayStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('â¹ï¸ KIOSK: Stopped track:', track.kind);
                    });
                    currentDisplayStream = null;
                }
                
                // Close existing peer connection if any
                if (pc) {
                    console.log('ðŸ”„ KIOSK: Closing existing peer connection before creating new one');
                    try {
                        pc.close();
                    } catch (e) {
                        console.warn('âš ï¸ Error closing old peer connection:', e);
                    }
                    pc = null;
                }
                
                // Create new peer connection
                console.log('ðŸ”— KIOSK: Creating new peer connection');
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        // TURN server for NAT traversal (fallback relay)
                        {
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ],
                    iceCandidatePoolSize: 10,
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require',
                    // ðŸš€ OPTIMIZATION: Enable aggressive ICE gathering
                    iceGatheringPolicy: 'all'
                });

                // Monitor connection state
                pc.onconnectionstatechange = () => {
                    const timestamp = new Date().toLocaleTimeString();
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    console.log(`ðŸ”„ KIOSK: Connection state changed: ${pc.connectionState} (${elapsed}s elapsed, ${timestamp})`);
                    
                    if (pc.connectionState === 'connected') {
                        console.log(`âœ… KIOSK: WebRTC connected successfully at ${elapsed}s`);
                        console.log('   ICE state:', pc.iceConnectionState);
                        console.log('   Signaling state:', pc.signalingState);
                    } else if (pc.connectionState === 'connecting') {
                        console.log(`ðŸ”— KIOSK: WebRTC connecting at ${elapsed}s...`);
                        console.log('   ICE state:', pc.iceConnectionState);
                        console.log('   Signaling state:', pc.signalingState);
                        
                        // ðŸ”¥ DTLS TIMEOUT WARNING: Reduced to 10s for faster feedback
                        setTimeout(() => {
                            if (pc && pc.connectionState === 'connecting') {
                                const elapsedNow = ((Date.now() - startTime) / 1000).toFixed(1);
                                console.error(`âš ï¸ KIOSK: Still connecting after ${elapsedNow}s (may be slow network)`);
                                console.error('   Current ICE state:', pc.iceConnectionState);
                                console.error('   Current signaling state:', pc.signalingState);
                            }
                        }, 10000);
                    } else if (pc.connectionState === 'disconnected') {
                        console.warn(`âš ï¸ KIOSK: WebRTC disconnected at ${elapsed}s - connection may recover automatically`);
                    } else if (pc.connectionState === 'failed') {
                        console.error(`âŒ KIOSK: WebRTC connection failed at ${elapsed}s`);
                    } else if (pc.connectionState === 'closed') {
                        console.log('â¹ï¸ KIOSK: WebRTC connection closed');
                    }
                };

                // Monitor ICE connection state
                pc.oniceconnectionstatechange = () => {
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    console.log(`ðŸ§Š KIOSK: ICE state: ${pc.iceConnectionState} (${elapsed}s)`);
                    
                    if (pc.iceConnectionState === 'connected') {
                        console.log(`âœ… KIOSK: ICE connected at ${elapsed}s`);
                    } else if (pc.iceConnectionState === 'disconnected') {
                        console.warn(`âš ï¸ KIOSK: ICE disconnected at ${elapsed}s - may reconnect`);
                    } else if (pc.iceConnectionState === 'failed') {
                        console.error(`âŒ KIOSK: ICE failed at ${elapsed}s`);
                    } else if (pc.iceConnectionState === 'checking') {
                        console.log(`ðŸ” KIOSK: ICE checking at ${elapsed}s...`);
                    } else if (pc.iceConnectionState === 'completed') {
                        console.log(`âœ… KIOSK: ICE completed at ${elapsed}s`);
                    }
                };

                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate && socket) {
                        // ðŸš€ TRICKLE ICE: Send candidates immediately for faster connection
                        console.log('ðŸ§Š KIOSK: Sending ICE candidate immediately:', event.candidate.type);
                        socket.emit('webrtc-ice-candidate', {
                            candidate: event.candidate,
                            sessionId: sessionId,
                            adminSocketId: adminSocketId  // Send to specific admin
                        });
                    } else if (!event.candidate) {
                        console.log('ðŸ§Š KIOSK: ICE gathering complete');
                    }
                };

                // Set remote description
                console.log('ðŸŽ¬ KIOSK: Setting remote description...');
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                console.log('âœ… KIOSK: Remote description set successfully');

                // ðŸŽ¥ CAPTURE DESKTOP SCREEN - Use pre-warmed stream if available
                console.log('ðŸŽ¥ ========================================');
                console.log('ðŸŽ¥ KIOSK: STARTING SCREEN CAPTURE');
                console.log('ðŸŽ¥ Pre-warmed stream available:', !!preWarmedStream);
                console.log('ðŸŽ¥ ========================================');
                let displayStream = null;
                
                // ðŸš€ INSTANT MIRRORING: Use pre-warmed stream if available
                if (preWarmedStream && preWarmedStream.getTracks().every(t => t.readyState === 'live')) {
                    console.log('ðŸš€ðŸš€ðŸš€ Using PRE-WARMED stream - INSTANT CONNECTION!');
                    displayStream = preWarmedStream;
                    console.log('âœ… Pre-warmed stream has', displayStream.getVideoTracks().length, 'video tracks');
                } else {
                    // Pre-warmed stream not available or tracks stopped, capture fresh
                    if (preWarmedStream) {
                        console.log('âš ï¸ Pre-warmed stream exists but tracks are not live, capturing fresh...');
                        preWarmedStream.getTracks().forEach(t => t.stop());
                        preWarmedStream = null;
                    }
                    
                    console.log('ðŸŽ¥ Capturing screen stream (no pre-warm available)...');
                    try {
                        // First try: navigator.mediaDevices.getDisplayMedia
                        console.log('ðŸŽ¥ KIOSK: Attempting getDisplayMedia() method...');
                        displayStream = await navigator.mediaDevices.getDisplayMedia({
                            video: {
                                cursor: 'always',
                                width: { ideal: 1920 },
                                height: { ideal: 1080 },
                                frameRate: { ideal: 30 }
                            },
                            audio: false
                        });
                        console.log('âœ…âœ…âœ… KIOSK: getDisplayMedia() SUCCEEDED!');
                        console.log('âœ… Video tracks:', displayStream.getVideoTracks().length);
                    } catch (error1) {
                        console.warn('âš ï¸ KIOSK: getDisplayMedia failed, trying alternative approach...');
                        console.warn('âš ï¸ Error:', error1.message);
                        
                        // Second try: Use desktopCapturer sources with getUserMedia
                        try {
                            console.log('ðŸŽ¥ KIOSK: Trying getUserMedia with chromeMediaSource...');
                            const sources = await window.electronAPI.getScreenSources();
                            console.log(`ðŸ“º KIOSK: Got ${sources.length} screen sources`);

                            if (sources.length === 0) {
                                throw new Error('No screen sources available');
                            }

                            // Use the primary screen
                            const screenSource = sources[0];
                            console.log(`ðŸ“º KIOSK: Using screen source: ${screenSource.name} (ID: ${screenSource.id})`);

                            displayStream = await navigator.mediaDevices.getUserMedia({
                                audio: false,
                                video: {
                                    mandatory: {
                                        chromeMediaSource: 'desktop',
                                        chromeMediaSourceId: screenSource.id,
                                        minWidth: 1280,
                                        maxWidth: 1920,
                                        minHeight: 720,
                                        maxHeight: 1080,
                                        maxFrameRate: 30
                                    }
                                }
                            });
                            console.log('âœ…âœ…âœ… KIOSK: getUserMedia with chromeMediaSource SUCCEEDED!');
                            console.log('âœ… Video tracks:', displayStream.getVideoTracks().length);
                        } catch (error2) {
                            console.error('âŒ KIOSK: Both methods failed');
                            console.error('  Method 1 (getDisplayMedia):', error1.message);
                            console.error('  Method 2 (getUserMedia+chrome):', error2.message);
                            throw new Error(`Screen capture failed: ${error1.message}`);
                        }
                    }
                }

                console.log('âœ… KIOSK: Screen captured successfully');
                console.log('âœ… KIOSK: Captured tracks:', displayStream.getTracks().length);
                displayStream.getTracks().forEach(track => {
                    console.log(`  - Track: ${track.kind}, label: ${track.label}, enabled: ${track.enabled}, readyState: ${track.readyState}`);
                });

                // Store stream for cleanup on next offer
                currentDisplayStream = displayStream;

                // Add video tracks to peer connection
                console.log('ðŸ“¹ KIOSK: Adding video tracks to peer connection...');
                displayStream.getVideoTracks().forEach((track) => {
                    console.log('ðŸ“¹ KIOSK: Adding video track:', track.label);
                    const sender = pc.addTrack(track, displayStream);
                    console.log('âœ… Track added, sender:', sender ? 'created' : 'failed');
                });

                console.log('âœ… KIOSK: Video tracks added to peer connection');

                // Handle screen stop
                if (displayStream.getVideoTracks()[0]) {
                    displayStream.getVideoTracks()[0].onended = () => {
                        console.log('â¹ï¸ KIOSK: Screen capture stopped by user');
                        if (pc) pc.close();
                    };
                }

                // Create answer
                console.log('ðŸŽ¬ KIOSK: Creating WebRTC answer...');
                const answer = await pc.createAnswer();
                console.log('âœ… KIOSK: Answer created:', answer.type);
                
                await pc.setLocalDescription(answer);
                console.log('âœ… KIOSK: Local description set');

                // Send answer back to admin
                console.log('ðŸ“¤ ========================================');
                console.log('ðŸ“¤ KIOSK: SENDING ANSWER TO ADMIN');
                console.log('ðŸ“¤ Admin Socket ID:', adminSocketId);
                console.log('ðŸ“¤ Session ID:', sessionId);
                console.log('ðŸ“¤ Socket connected:', socket.connected);
                console.log('ðŸ“¤ Socket ID:', socket.id);
                console.log('ðŸ“¤ ========================================');
                
                socket.emit('webrtc-answer', {
                    answer: answer,
                    adminSocketId: adminSocketId,
                    sessionId: sessionId
                });

                console.log('âœ…âœ…âœ… KIOSK: Answer sent to admin with video stream');
                console.log('âœ… If admin doesn\'t get this, check server forwarding!');
                console.log('ðŸ“¹ ========================================');
            } catch (error) {
                console.error('âŒ KIOSK: Error in WebRTC handshake:', error);
                console.error('âŒ KIOSK: Stack:', error.stack);
                if (socket) {
                    socket.emit('webrtc-error', {
                        error: error.message,
                        sessionId: sessionId,
                        details: {
                            pcState: pc ? pc.connectionState : 'no-pc',
                            iceState: pc ? pc.iceConnectionState : 'no-pc',
                            hasStream: !!currentDisplayStream,
                            elapsedTime: ((Date.now() - startTime) / 1000).toFixed(2)
                        }
                    });
                }
            } finally {
                // Clear processing flag
                isProcessingOffer = false;
                console.log('âœ… KIOSK: Offer processing complete, ready for next offer');
            }
        }

        async function handleGuestMode(data) {
            console.log('ðŸ”“ Activating guest mode');
            try {
                const systemNumber = document.getElementById('systemNumber').textContent;
                const result = await window.electronAPI.studentLogin({
                    studentId: 'GUEST',
                    password: 'admin123',
                    systemNumber,
                    isGuest: true
                });

                if (result.success) {
                    document.getElementById('sessionStudentName').textContent = 'Guest User';
                    document.getElementById('sessionStudentId').textContent = 'GUEST';
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    document.querySelector('.login-container').style.display = 'none';
                    document.getElementById('sessionModal').classList.add('active');
                }
            } catch (error) {
                console.error('âŒ Guest mode error:', error);
            }
        }

        // ðŸ”“ HANDLE GUEST ACCESS (Admin-initiated remote unlock)
        async function handleGuestAccess(data) {
            console.log('ðŸ”“ ========================================');
            console.log('ðŸ”“ GUEST ACCESS ACTIVATED BY ADMIN');
            console.log('ðŸ”“ System:', data.systemNumber);
            console.log('ðŸ”“ Enabled by:', data.enabledBy);
            console.log('ðŸ”“ ========================================');

            try {
                const systemNumber = document.getElementById('systemNumber').textContent;
                
                // Hide login screen
                const loginContainer = document.querySelector('.login-container');
                if (loginContainer) {
                    loginContainer.style.display = 'none';
                }

                // Show guest session screen
                const sessionModal = document.getElementById('sessionModal');
                if (sessionModal) {
                    // Update session info with guest details
                    document.getElementById('sessionStudentName').textContent = 'ðŸ‘¤ Guest User';
                    document.getElementById('sessionStudentId').textContent = 'GUEST';
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    
                    sessionModal.classList.add('active');
                }

                // Show success message
                showError('ðŸ”“ Guest Access Enabled by Admin - System Unlocked', 'success');

                // Notify Electron main process to release kiosk mode (minimize restrictions)
                if (window.electronAPI && window.electronAPI.studentLogin) {
                    const result = await window.electronAPI.studentLogin({
                        studentId: 'GUEST',
                        password: data.guestPassword || 'admin123',
                        systemNumber: systemNumber,
                        isGuest: true,
                        guestMode: true
                    });

                    console.log('âœ… Guest login result:', result);
                }

                // Confirm back to server that guest access is active
                if (socket && socket.connected) {
                    socket.emit('guest-access-confirmed', {
                        systemNumber: systemNumber,
                        studentInfo: {
                            studentId: 'GUEST',
                            studentName: 'Guest User',
                            systemNumber: systemNumber,
                            isGuest: true
                        }
                    });
                    console.log('âœ… Guest access confirmation sent to server');
                }

                // Add visual indicator that system is in guest mode
                const statusDiv = document.createElement('div');
                statusDiv.id = 'guest-mode-indicator';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: bold;
                    z-index: 99999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                statusDiv.textContent = 'ðŸ”“ GUEST MODE - Unlocked by Admin';
                document.body.appendChild(statusDiv);

            } catch (error) {
                console.error('âŒ Error activating guest access:', error);
                showError('âŒ Failed to activate guest access', 'error');
            }
        }

        // Listen for session-created event from main process
        if (window.electronAPI && window.electronAPI.onSessionCreated) {
            window.electronAPI.onSessionCreated((data) => {
                console.log('ðŸ“¹ ========================================');
                console.log('ðŸ“¹ SESSION CREATED EVENT RECEIVED');
                console.log('ðŸ“¹ Session ID:', data.sessionId);
                console.log('ðŸ“¹ Server URL:', data.serverUrl);
                console.log('ðŸ“¹ Student Info:', JSON.stringify(data.studentInfo, null, 2));
                console.log('ðŸ“¹ ========================================');
                
                // ðŸŽ« RE-REGISTER KIOSK WITH SESSION ID FOR SCREEN MIRRORING
                if (data.sessionId && socket && socket.connected) {
                    console.log(`ðŸŽ« KIOSK: Re-registering with sessionId: ${data.sessionId}`);
                    console.log(`ðŸŽ« Socket connected: ${socket.connected}`);
                    console.log(`ðŸŽ« Socket ID: ${socket.id}`);
                    
                    socket.emit('register-kiosk', {
                        sessionId: data.sessionId,
                        systemNumber: data.studentInfo.systemNumber,
                        labId: 'CC1'
                    });
                    console.log('âœ… KIOSK: Re-registered with session ID - ready for screen mirroring');
                    
                    // ðŸš€ PRE-WARM: Capture screen stream immediately for instant mirroring
                    preWarmScreenCapture().then(() => {
                        console.log('âœ… Screen pre-warmed and ready for instant mirroring');
                        
                        // Notify server that screen is ready for monitoring
                        console.log('ðŸ“º KIOSK: Emitting kiosk-screen-ready event...');
                        socket.emit('kiosk-screen-ready', {
                            sessionId: data.sessionId,
                            hasVideo: true,
                            timestamp: new Date().toISOString()
                        });
                        console.log('âœ… KIOSK: Screen ready event emitted - instant connection possible');
                    }).catch(err => {
                        console.error('âŒ Pre-warm failed:', err.message);
                        // Still notify server, will capture on-demand
                        socket.emit('kiosk-screen-ready', {
                            sessionId: data.sessionId,
                            hasVideo: false,
                            timestamp: new Date().toISOString()
                        });
                    });
                } else {
                    console.error('âŒ Cannot re-register kiosk:');
                    console.error('  - Session ID:', data.sessionId || 'missing');
                    console.error('  - Socket exists:', !!socket);
                    console.error('  - Socket connected:', socket ? socket.connected : 'N/A');
                }
                
                // Note: Screen mirroring is handled in background for admin monitoring
                // No visual feedback needed for student
            });
        } else {
            console.error('âŒ window.electronAPI.onSessionCreated not available');
        }
        
        // Listen for trigger-logout event from timer window
        if (window.electronAPI && window.electronAPI.onTriggerLogout) {
            window.electronAPI.onTriggerLogout(() => {
                console.log('ðŸšª Trigger logout received from timer window');
                logout();
            });
        }

        // Time update
        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('currentTime');
            if (timeEl) timeEl.textContent = now.toLocaleTimeString();
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                if (!window.electronAPI || !window.electronAPI.getSystemInfo) {
                    console.log('âš ï¸ window.electronAPI not available');
                    return;
                }
                const sysInfo = await window.electronAPI.getSystemInfo();
                document.getElementById('computerName').textContent = sysInfo.hostname;
                document.getElementById('systemNumber').textContent = sysInfo.systemNumber || 'CC1-01';
                console.log(`âœ… System info loaded: ${sysInfo.hostname}`);
            } catch (error) {
                console.error(`âŒ Error: ${error.message}`);
            }
        }

        // Start time updates
        updateTime();
        setInterval(updateTime, 1000);

        // Initialize
        setTimeout(() => {
            loadSystemInfo();
            initializeSocket();
        }, 300);

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value.trim();
            const password = document.getElementById('password').value;
            const systemNumber = document.getElementById('systemNumber').textContent;

            if (!studentId || !password) {
                showError('Please enter Student ID and Password');
                return;
            }

            console.log(`ðŸ” Login attempt for: ${studentId}`);

            try {
                const result = await window.electronAPI.studentLogin({
                    studentId,
                    password,
                    systemNumber
                });

                if (result.success) {
                    console.log(`âœ… Login successful!`);
                    console.log(`ðŸŽ« KIOSK: Updating registration with sessionId: ${result.sessionId}`);
                    
                    // ðŸŽ« RE-REGISTER KIOSK WITH SESSION ID (for screen mirroring)
                    if (socket && socket.connected) {
                        socket.emit('register-kiosk', {
                            sessionId: result.sessionId,
                            systemNumber: systemNumber,
                            labId: 'CC1'  // Default lab
                        });
                    }
                    
                    document.getElementById('sessionStudentName').textContent = result.student.name;
                    document.getElementById('sessionStudentId').textContent = result.student.studentId;
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    document.querySelector('.login-container').style.display = 'none';
                    document.getElementById('sessionModal').classList.add('active');
                } else {
                    showError(result.error || 'Login failed');
                }
            } catch (error) {
                showError('Login error: ' + error.message);
            }
        });

        function showError(msg, type = 'error') {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = msg;
            
            // Add/remove success class based on type
            alert.classList.remove('success');
            if (type === 'success') {
                alert.classList.add('success');
            }
            
            alert.classList.add('show');
            setTimeout(() => {
                alert.classList.remove('show');
                alert.classList.remove('success');
            }, 5000);
        }

        function showForgotPassword() {
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotStep1').style.display = 'block';
            document.getElementById('forgotStep2').style.display = 'none';
            document.getElementById('forgotStep3').style.display = 'none';
        }

        function forgotPasswordStep2() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            if (!studentId) {
                showError('Please enter your Student ID');
                return;
            }
            document.getElementById('forgotStep1').style.display = 'none';
            document.getElementById('forgotStep2').style.display = 'block';
        }

        // Validate email domain
        function validateEmail(email) {
            const emailPattern = /^[^\s@]+@psgitech\.ac\.in$/i;
            return emailPattern.test(email);
        }

        async function sendOTP() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                showError('Please enter your email address');
                return;
            }

            // Validate email domain
            if (!validateEmail(email)) {
                showError('âŒ Invalid email! Only @psgitech.ac.in emails are allowed');
                return;
            }

            try {
                const serverUrl = await window.electronAPI.getServerUrl();
                const response = await fetch(`${serverUrl}/api/forgot-password-send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, email })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('forgotStep2').style.display = 'none';
                    document.getElementById('forgotStep3').style.display = 'block';
                } else {
                    showError(data.error || 'Failed to send OTP');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function verifyOTP() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            const otp = document.getElementById('otpCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!otp || !newPassword || !confirmPassword) {
                showError('Please fill all fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            try {
                const serverUrl = await window.electronAPI.getServerUrl();
                const response = await fetch(`${serverUrl}/api/forgot-password-verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, email, otp, newPassword })
                });
                const data = await response.json();

                if (data.success) {
                    // Close modal first
                    showLoginPage();
                    // Show success message
                    showError('âœ… Password reset successfully!', 'success');
                    // Auto-fill and auto-login after 1 second
                    setTimeout(() => {
                        document.getElementById('studentId').value = studentId;
                        document.getElementById('password').value = newPassword;
                        // Auto-submit login
                        document.querySelector('.login-form').dispatchEvent(new Event('submit'));
                    }, 1000);
                } else {
                    showError(data.error || 'OTP verification failed');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function showFirstTimeSignin() {
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('firstTimeModal').classList.add('active');
        }

        document.getElementById('firstTimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const studentId = document.getElementById('ftStudentId').value.trim();
            const email = document.getElementById('ftEmail').value.trim();
            const dob = document.getElementById('ftDOB').value;
            const password = document.getElementById('ftPassword').value;
            const confirmPassword = document.getElementById('ftConfirmPassword').value;

            // Validate email domain
            if (!validateEmail(email)) {
                showError('âŒ Invalid email! Only @psgitech.ac.in emails are allowed');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            try {
                const serverUrl = await window.electronAPI.getServerUrl();
                
                const requestData = { studentId, email, dateOfBirth: dob, newPassword: password };
                console.log('ðŸ” First-time sign-in request:', requestData);
                
                const response = await fetch(`${serverUrl}/api/first-time-signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('ðŸ” First-time sign-in response:', data);

                if (data.success) {
                    console.log('âœ… First-time sign-in successful!');
                    // Close modal first
                    showLoginPage();
                    // Show success message
                    showError('âœ… Password set successfully! Logging you in...', 'success');
                    // Auto-fill and auto-login after 1 second
                    setTimeout(() => {
                        document.getElementById('studentId').value = studentId;
                        document.getElementById('password').value = password;
                        // Auto-submit login
                        document.querySelector('.login-form').dispatchEvent(new Event('submit'));
                    }, 1000);
                } else {
                    console.error('âŒ First-time sign-in failed:', data.error);
                    showError(data.error || 'Sign-in failed');
                }
            } catch (error) {
                console.error('âŒ First-time sign-in error:', error);
                showError('Error: ' + error.message);
            }
        });

        function showGuestLogin() {
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('guestLoginModal').classList.add('active');
            // Clear previous input
            document.getElementById('guestPassword').value = '';
        }

        // Guest Login Form Handler
        document.getElementById('guestLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const guestPassword = document.getElementById('guestPassword').value.trim();
            const systemNumber = document.getElementById('systemNumber').textContent;

            if (!guestPassword || guestPassword.length !== 4) {
                showError('Please enter a valid 4-digit password');
                return;
            }

            console.log(`ðŸ” Guest login attempt`);

            try {
                const result = await window.electronAPI.guestLogin({
                    password: guestPassword,
                    systemNumber
                });

                if (result.success) {
                    console.log(`âœ… Guest login successful!`);
                    console.log(`ðŸŽ« KIOSK: Updating registration with sessionId: ${result.sessionId}`);
                    
                    // ðŸŽ« RE-REGISTER KIOSK WITH SESSION ID (for screen mirroring)
                    if (socket && socket.connected) {
                        socket.emit('register-kiosk', {
                            sessionId: result.sessionId,
                            systemNumber: systemNumber,
                            labId: 'CC1',  // Default lab
                            isGuest: true
                        });
                    }
                    
                    document.getElementById('sessionStudentName').textContent = 'Guest User';
                    document.getElementById('sessionStudentId').textContent = 'GUEST';
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    document.querySelector('.login-container').style.display = 'none';
                    document.getElementById('guestLoginModal').classList.remove('active');
                    document.getElementById('sessionModal').classList.add('active');
                } else {
                    showError(result.error || 'Guest login failed. Invalid password.');
                }
            } catch (error) {
                showError('Guest login error: ' + error.message);
            }
        });

        function showLoginPage() {
            document.querySelector('.login-container').style.display = 'flex';
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('firstTimeModal').classList.remove('active');
            document.getElementById('guestLoginModal').classList.remove('active');
            document.getElementById('sessionModal').classList.remove('active');
        }

        function handleSessionEnded(data) {
            console.log('ðŸ›‘ Session has ended by admin or automatic timetable');
            
            // Show alert notification
            showError('Session has ended. Please log out and the system will shut down.');
            
            // Show countdown timer for 60 seconds (1 minute)
            let secondsRemaining = 60;
            const countdownInterval = setInterval(() => {
                console.log(`â³ Countdown: ${secondsRemaining} seconds remaining`);
                showError(`Session ended. Logout required. Auto-shutdown in ${secondsRemaining}s`);
                secondsRemaining--;
                
                if (secondsRemaining <= 0) {
                    clearInterval(countdownInterval);
                    console.log('â±ï¸ Session end countdown complete. Performing logout...');
                    logout();
                }
            }, 1000);
            
            // If user clicks logout before countdown, clean logout
            const logoutBtn = document.querySelector('[onclick="logout()"]');
            if (logoutBtn) {
                const originalOnclick = logoutBtn.onclick;
                logoutBtn.onclick = () => {
                    clearInterval(countdownInterval);
                    originalOnclick();
                };
            }
        }

        // Prevent multiple logout calls
        let isLoggingOut = false;
        
        async function logout() {
            console.log('ðŸšª Logout button clicked');
            
            // Prevent multiple logout calls
            if (isLoggingOut) {
                console.log('âš ï¸ Logout already in progress, ignoring duplicate call');
                return;
            }
            isLoggingOut = true;
            
            if (window.electronAPI && window.electronAPI.studentLogout) {
                try {
                    // ðŸ”Œ STEP 1: Show shutdown dialog BEFORE logout
                    console.log('âš ï¸ Showing shutdown warning dialog...');
                    if (window.electronAPI.showShutdownDialog) {
                        try {
                            await window.electronAPI.showShutdownDialog();
                            console.log('âœ… Shutdown dialog shown');
                        } catch (error) {
                            console.error('âš ï¸ Failed to show shutdown dialog:', error);
                        }
                    }
                    
                    // ðŸšª STEP 2: Perform logout (ends session)
                    console.log('ðŸšª Performing logout...');
                    const result = await window.electronAPI.studentLogout();
                    console.log('âœ… Logout result:', result);
                    
                    if (result.success) {
                        console.log('âœ… Logout successful, initiating system shutdown...');
                        
                        // ðŸ§¹ Clean up screen streams
                        if (preWarmedStream) {
                            preWarmedStream.getTracks().forEach(t => t.stop());
                            preWarmedStream = null;
                            isScreenReady = false;
                            console.log('âœ… Pre-warmed stream cleaned up');
                        }
                        if (currentDisplayStream) {
                            currentDisplayStream.getTracks().forEach(t => t.stop());
                            currentDisplayStream = null;
                            console.log('âœ… Current display stream cleaned up');
                        }
                        if (pc) {
                            pc.close();
                            pc = null;
                            console.log('âœ… Peer connection closed');
                        }
                        
                        // Hide session modal
                        document.getElementById('sessionModal').classList.remove('active');
                        
                        // Show login container
                        document.querySelector('.login-container').style.display = 'flex';
                        
                        // Clear form fields
                        document.getElementById('studentId').value = '';
                        document.getElementById('password').value = '';
                        
                        // ðŸ”Œ STEP 3: Call shutdown system (60-second delay shutdown)
                        console.log('ðŸ”Œ Initiating system shutdown in 60 seconds...');
                        if (window.electronAPI.shutdownSystem) {
                            try {
                                const shutdownResult = await window.electronAPI.shutdownSystem();
                                console.log('âœ… Shutdown result:', shutdownResult);
                                
                                if (shutdownResult.success) {
                                    console.log('âœ…âœ…âœ… SHUTDOWN COMMAND EXECUTED!');
                                    console.log('âœ… System will shut down in 60 seconds');
                                    
                                    // Show shutdown message with actual delay from result
                                    const delay = shutdownResult.delay || 60;
                                    showError(`âš ï¸ SYSTEM SHUTTING DOWN IN ${delay} SECONDS! Session ended.`, 'success');
                                } else {
                                    console.error('âŒ Shutdown command failed:', shutdownResult.error);
                                    showError(`âŒ Shutdown failed: ${shutdownResult.error}. Please manually shutdown.`, 'error');
                                }
                            } catch (shutdownError) {
                                console.error('âŒ Shutdown exception:', shutdownError);
                                showError('âŒ Shutdown error: ' + shutdownError.message, 'error');
                            }
                        } else {
                            console.error('âŒ shutdownSystem API not available');
                            showError('âŒ Shutdown not available - please manually shutdown', 'error');
                        }
                        
                        // Reset logging out flag
                        isLoggingOut = false;
                        
                        console.log('ðŸ”’ Session ended - system will shutdown in 90 seconds');
                    } else {
                        console.error('âŒ Logout failed:', result.error || 'Unknown error');
                        isLoggingOut = false; // Reset flag on failure
                        // âœ… FIX: Only show error if there's an actual error (not if just no session)
                        if (result.error && result.error !== 'No active session') {
                            showError('Logout failed: ' + result.error, 'error');
                        } else {
                            // If no active session, just return to login screen silently
                            document.getElementById('sessionModal').classList.remove('active');
                            document.querySelector('.login-container').style.display = 'flex';
                        }
                    }
                } catch (error) {
                    console.error('âŒ Logout error:', error);
                    isLoggingOut = false; // Reset flag on error
                    // âœ… FIX: More informative error message
                    showError('Logout error: ' + (error.message || 'Unknown error'), 'error');
                }
            } else {
                console.error('âŒ electronAPI.studentLogout not available');
                isLoggingOut = false; // Reset flag
                showError('Logout functionality not available', 'error');
            }
        }

        // Track login state
        let isLoggedIn = false;
        
        // Listen for login success to disable kiosk blocking
        window.addEventListener('message', (event) => {
            if (event.data === 'student-logged-in') {
                isLoggedIn = true;
                console.log('ðŸ”“ Student logged in - keyboard shortcuts now allowed');
            }
        });

        // ðŸ”’ KIOSK MODE: Block ALL keyboard shortcuts including Escape (only before login)
        document.addEventListener('keydown', function(e) {
            // After login, allow all keys
            if (isLoggedIn) {
                return;
            }
            
            // âœ… FIX: Allow normal typing in input fields
            // Don't block alphanumeric keys, numbers, backspace, delete, etc. when in input fields
            const target = e.target;
            const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
            
            if (isInputField) {
                // Allow normal input characters in input fields
                const allowedKeys = [
                    'Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 
                    'ArrowUp', 'ArrowDown', 'Home', 'End', 'Shift', 'CapsLock'
                ];
                
                // Allow alphanumeric characters (a-z, 0-9) and allowed special keys
                const isAlphanumeric = /^[a-zA-Z0-9]$/.test(e.key);
                const isAllowedKey = allowedKeys.includes(e.key);
                const isSpecialChar = e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey;
                
                if (isAlphanumeric || isAllowedKey || isSpecialChar) {
                    // Allow normal typing in input fields
                    return;
                }
            }
            
            // Block Escape key from exiting fullscreen
            if (e.key === 'Escape' || e.key === 'Esc') {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸš« Blocked Escape key');
                return false;
            }
            
            // Block F11 (fullscreen toggle)
            if (e.key === 'F11') {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸš« Blocked F11 key');
                return false;
            }
            
            // Block Alt+F4, Alt+Tab, Alt+Escape, etc.
            if (e.altKey) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸš« Blocked Alt+' + e.key);
                return false;
            }
            
            if (e.ctrlKey && (e.key === 'w' || e.key === 'W' || e.key === 'q' || e.key === 'Q')) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸš« Blocked Ctrl+' + e.key);
                return false;
            }
            
            // Block Windows key
            if (e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸš« Blocked Windows key');
                return false;
            }
        }, true); // Use capture phase to catch before other handlers

        console.log('âœ… Application ready');
    </script>
</body>
</html>
